# Sourcegraph with Kubernetes

<p class="lead">
Deploying Sourcegraph on Kubernetes is for organizations that need highly scalable and available code search and code navigation.
</p>

<div class="getting-started">
  <a href="./kustomize" class="btn btn-primary" alt="Configure">
   <span>Kustomize</span>
   </br>
   Deploy Sourcegraph with simple kubectl commands
  </a>

  <a href="./helm" class="btn" alt="Overlays">
   <span>Helm</span>
   </br>
   Deploy Sourcegraph with Helm
  </a>
</div>

<div class="getting-started">
<a class="btn btn-primary text-center" href="#installation">â˜… Installation</a>
<a class="btn text-center" href="kustomize/configure">Configuration</a>
<a class="btn text-center" href="../instance-size">Instance Sizes</a>
<a class="btn text-center" href="operations">Operations</a>
</div>

## Prerequisites

Not sure if Kubernetes is the right choice for you? Learn more about other [Sourcegraph installation options](../index.md).

1. [Sourcegraph Enterprise license](kustomize/configure.md#add-license-key). _You can run through these instructions without one, but you must obtain a license for instances of more than 10 users_
2. A [Kubernetes](https://kubernetes.io/) cluster
   - Minimum Kubernetes version: [v1.19](https://kubernetes.io/blog/2020/08/26/kubernetes-release-1.19-accentuate-the-paw-sitive/) with [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) v1.19 or later
   - [Kustomize](https://kustomize.io/) (built into `kubectl` in version >= 1.14)
   - Support for Persistent Volumes (SSDs recommended)
3. [Cluster role administrator access](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)
4. A private local copy of the [Sourcegraph reference repository for Kubernetes](#deployment-repository)
5. Determine your instance size using our [instance size chart](../../instance-size.md)

### Deployment repository

Sourcegraph for Kubernetes is configured using our [reference repository: `sourcegraph/deploy-sourcegraph`](https://github.com/sourcegraph/deploy-sourcegraph/). This repository contains everything you need to [configure](kustomize/configure.md) and [deploy](kustomize#deploy) a Sourcegraph deployment on Kubernetes.

Follow our [reference repository docs](../repositories.md) to create a private copy of the reference repository.

## Configure

The default deployment includes the necessary services to start Sourcegraph. It does not includes services or configurations that your cluster needs to run Sourcegraph successfully. As a result, additional [configuration](kustomize/configure.md) might be required in order to deploy Sourcegraph to your Kubernetes cluster successfully.
Common configurations include:

- Adjust [resources](kustomize/configure.md#resources-adjustment)
- Create [storage class](kustomize/configure.md#storage-class)
- Set up network access via [ingress-controller](kustomize/configure.md#ingress-controller)
- Set up an [external PostgreSQL Database](kustomize/configure.md#external-databases)
- Set up [SSH connection for cloning repositories](kustomize/configure.md##repository-cloning-via-ssh)

For more information, please read the [configuration guide](kustomize/configure.md) before installing Sourcegraph.

## Quick start

The instructions below only works on clusters that are pre-configured and do not require additional configurations. If you are deploying to a cluster that are hosted on a service provider (eg. AWS, Google Kubernetes Engine (GKE), please deploy following the instruction in our [configuration guide](kustomize/configure.md).

Follow the instructions below to deploy the latest version of Sourcegraph with default settings to your cluster using Kustomize overlays for Sourcegraph.

#### Step 1: Deploy Sourcegraph

> NOTE: This assumes your cluster has already been configured to run Sourcegraph with [Ingress Controller](https://github.com/kubernetes/ingress-nginx) installed.

Run below command to deploy a pre-configured Sourcegraph instance without the monitoring stacks to your cluster.

```bash
kubectl apply -k https://github.com/sourcegraph/deploy-sourcegraph/new/quick-start/base/xs?ref=v4.4.0
```

#### Step 2: Access Sourcegraph

When the status of all Sourcegraph services are shown to be `Running`, it means the deployment has been completed successfully. You can then make the frontend accessible temporarily by connecting to the sourcegraph-frontend service in your Kubernetes cluster using [kubectl port-forward](https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/):

```sh
kubectl port-forward svc/sourcegraph-frontend 3080:30080
```

You can access Sourcegraph in your browser at http://localhost:3080 ðŸŽ‰ You can also access your Sourcegraph instance through ingress if an [`ingress-controller`](kustomize/configure.md#ingress-controller) is available in your cluster.

#### Preview resources

To examine the resources generated by the Sourcegraph's quick-start kustomize overlay:

```bash
kustomize build https://github.com/sourcegraph/deploy-sourcegraph/new/quick-start/k3s/xs?ref=v4.4.0
```
