# Sourcegraph with Kubernetes

<p class="lead">
Deploying Sourcegraph on Kubernetes is for organizations that need highly scalable and available code search and code navigation.
</p>

<div class="getting-started">
  <a href="#prerequisites" class="btn btn-primary" alt="Configure">
   <span>Kustomize</span>
   </br>
   Deploy Sourcegraph with simple kubectl commands
  </a>

  <a href="./helm" class="btn" alt="Overlays">
   <span>Helm</span>
   </br>
   Deploy Sourcegraph with Helm
  </a>
</div>

<div class="getting-started">
<a class="btn btn-primary text-center" href="#installation">â˜… Installation</a>
<a class="btn text-center" href="configure">Configuration</a>
<a class="btn text-center" href="../../instance-size">Instance Size</a>
<a class="btn text-center" href="operations">Operations</a>
</div>

## Prerequisites

Not sure if Kubernetes is the right choice for you? Learn more about other [Sourcegraph installation options](../index.md).

1. [Sourcegraph Enterprise license](configure.md#add-license-key). _You can run through these instructions without one, but you must obtain a license for instances of more than 10 users_
2. A [Kubernetes](https://kubernetes.io/) cluster
   - Minimum Kubernetes version: [v1.19](https://kubernetes.io/blog/2020/08/26/kubernetes-release-1.19-accentuate-the-paw-sitive/) with [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) v1.19 or later
   - [Kustomize](https://kustomize.io/) (built into `kubectl` in version >= 1.14)
   - Support for Persistent Volumes (SSDs recommended)
3. [Cluster role administrator access](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)
4. A private local copy of the [Sourcegraph deployment repository for Kubernetes](#deployment-repository)

### Deployment repository

Sourcegraph for Kubernetes is configured using our [deployment repository: `sourcegraph/deploy-sourcegraph`](https://github.com/sourcegraph/deploy-sourcegraph/). This repository contains everything you need to [set up](#installation) and [configure](./configure.md) a Sourcegraph deployment on Kubernetes, including the [Kustomize overlays](kustomize/index.md).

Follow our [deployment repository docs](../repositories.md) to create a private copy of the deployment repository.


## Configure

Further [configuration](kustomize/configure.md) might be required in order to deploy Sourcegraph to your cluster (eg. [update storage class](./configure.md#configure-a-storage-class), [configure network access](./configure.md#configure-network-access), [use external PostgreSQL Database](./configure.md#configure-external-databases) or [update resources](./scale.md#tuning-replica-counts-for-horizontal-scalability)). For more information, please read the [configuration guide](kustomize/configure.md) before installing Sourcegraph.

## Quick start

The instructions below only works on clusters that are pre-configured and do not require additional configurations. If you are deploying to a cluster that are hosted on a service provider (eg. AWS, Google Kubernetes Engine (GKE), please deploy following the instruction in our [configuration guide](kustomize/configure.md).

Follow the instructions below to deploy the latest version of Sourcegraph with default settings to your cluster using Kustomize overlays for Sourcegraph.

#### Step 1: Deploy Sourcegraph

Follow the steps below to deploy a pre-configured Sourcegraph instance to your cluster.

##### Cluster with RBAC

Deploy Sourcegraph with all monitoring services:

```bash
kubectl apply -k https://github.com/sourcegraph/deploy-sourcegraph/new/overlays/quick-start/full/xs?ref=v4.4.0
```

##### Cluster without RBAC

If RBAC is not enabled in your cluster, you can deploy Sourcegraph without the monitoring stacks:

```bash
kubectl apply -k https://github.com/sourcegraph/deploy-sourcegraph/new/overlays/quick-start/basic/xs?ref=v4.4.0
```

#### Step 2: Access Sourcegraph in browser

When the status of all Sourcegraph services are shown to be `Running`, it means the deployment has been completed successfully. You can then make the frontend accessible temporarily by connecting to the sourcegraph-frontend service in your Kubernetes cluster using [kubectl port-forward](https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/):

```sh
kubectl port-forward svc/sourcegraph-frontend 3080:30080
```

You can access Sourcegraph in your browser at http://localhost:3080 ðŸŽ‰ If [`ingress-controller`](./configure.md#ingress-controller-recommended) is already configured in your cluster, you can also access your Sourcegraph instance through ingress.

#### Preview resources

To examine the resources generated by the Sourcegraph's quick-start kustomize overlay:

```bash
kubectl kustomize https://github.com/sourcegraph/deploy-sourcegraph/new/overlays/quick-start/k3s/xs?ref=v4.4.0
```

### Cloud installation

> WARNING: If you intend to set this up as a production instance, we recommend you create the cluster in a VPC
> or other secure network that restricts unauthenticated access from the public Internet. You can later expose the
> necessary ports via an
> [Internet Gateway](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Internet_Gateway.html) or equivalent
> mechanism. Note that SG must expose port 443 for outbound traffic to codehosts and to enable [telemetry](https://docs.sourcegraph.com/admin/pings) with
> Sourcegraph.com. Additionally port 22 may be opened to enable git SSH cloning by Sourcegraph. Take care to secure your cluster in a manner that meets your
> organization's security requirements.

Follow the instructions linked in the table below to provision a Kubernetes cluster for the
infrastructure provider of your choice, using the recommended node and list types in the
table.

| **Provider**                       | **Node type**                   | **Boot/ephemeral disk size** |
|------------------------------------|---------------------------------|------------------------------|
|[Amazon EKS (better than plain EC2)](eks.md)| m5.4xlarge | 100 GB (SSD preferred) |
|[AWS EC2](https://kubernetes.io/docs/getting-started-guides/aws/)| m5.4xlarge |  100 GB (SSD preferred) |
|[Google Kubernetes Engine (GKE)](https://cloud.google.com/kubernetes-engine/docs/quickstart)| n2-standard-16 | 100 GB (default) |
|[Azure](azure.md)| D16 v3 | 100 GB (SSD preferred) |
|[Other](https://kubernetes.io/docs/setup/production-environment/turnkey-solutions/)| 16 vCPU, 60 GiB memory per node | 100 GB (SSD preferred) |

<span class="virtual-br"></span>

> NOTE: Sourcegraph can run on any Kubernetes cluster, so if your infrastructure provider is not
> listed, see the "Other" row. Pull requests to add rows for more infrastructure providers are
> welcome!

<span class="virtual-br"></span>

> WARNING: If you are deploying on Azure, you **must** ensure that [your cluster is created with support for CSI storage drivers](https://docs.microsoft.com/en-us/azure/aks/csi-storage-drivers). This **can not** be enabled after the fact.
